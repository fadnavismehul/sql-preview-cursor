
> sql-preview@0.2.1 pretest
> npm run quality-check


> sql-preview@0.2.1 quality-check
> npm run type-check && npm run lint && npm run format:check


> sql-preview@0.2.1 type-check
> tsc --noEmit


> sql-preview@0.2.1 lint
> eslint src --ext ts


/Users/mehul.fadnavis/Desktop/Work/Code/project-preview/src/resultsViewProvider.ts
  390:24  warning  Forbidden non-null assertion  @typescript-eslint/no-non-null-assertion
  708:7   warning  Forbidden non-null assertion  @typescript-eslint/no-non-null-assertion
  717:9   warning  Forbidden non-null assertion  @typescript-eslint/no-non-null-assertion
  732:9   warning  Forbidden non-null assertion  @typescript-eslint/no-non-null-assertion

/Users/mehul.fadnavis/Desktop/Work/Code/project-preview/src/test/suite/persistence.test.ts
   92:28  warning  Forbidden non-null assertion  @typescript-eslint/no-non-null-assertion
  121:21  warning  Forbidden non-null assertion  @typescript-eslint/no-non-null-assertion

✖ 6 problems (0 errors, 6 warnings)


> sql-preview@0.2.1 format:check
> prettier --check "src/**/*.{ts,js,json}"

Checking formatting...
All matched files use Prettier code style!

> sql-preview@0.2.1 test
> jest --config jest.config.js

PASS src/test/suite/resultsView.test.ts
  ResultsViewProvider Tests
    ✓ should show results with truncation warning when results exceed maxRowsToDisplay (6 ms)
    ✓ should show results without truncation warning when results within limit (1 ms)
    ✓ should show results for specific tab
    ✓ should handle empty results
    ✓ should handle error messages
    ✓ should show loading state
    ✓ should show status messages
    ✓ should create a new tab
    ✓ should create a new tab with specific ID (2 ms)
    ✓ should get or create active tab ID (1 ms)
    ✓ should close active tab
    ✓ should close other tabs
    ✓ should close all tabs (1 ms)
    ✓ should create tab with source file URI
    ✓ should filter tabs when active editor changes

PASS src/test/suite/windows-path.test.ts
  Windows Path Compatibility
    ✓ Path normalization handles empty paths correctly (3 ms)
    ✓ Path normalization handles valid paths correctly
    ✓ URI path validation handles edge cases
    ✓ Resource path construction validation
    ✓ Validation logic properly handles filesystem checks (1 ms)

PASS src/test/suite/webviewTabManagement.test.ts
  Webview Tab Management Tests
    JavaScript Code Structure
      ✓ should contain tab management functions (2 ms)
      ✓ should contain context menu functionality
      ✓ should handle new message types
      ✓ should maintain state persistence
    Context Menu Implementation
      ✓ should define context menu structure
      ✓ should handle menu positioning
      ✓ should handle menu cleanup
    Tab Management Logic
      ✓ should handle tab creation with IDs
      ✓ should handle active tab management
      ✓ should handle tab closure logic
      ✓ should handle batch tab operations
    Error Handling
      ✓ should handle missing elements gracefully
      ✓ should handle grid API errors

PASS src/test/suite/codeLens.test.ts
  CodeLens Tests
    CodeLens Provider
      ✓ should provide both Run and Run (+ Tab) CodeLenses for single query (3 ms)
      ✓ should provide CodeLenses for multiple queries
      ✓ should handle queries with comments and whitespace
      ✓ should not provide CodeLenses for empty queries (1 ms)
      ✓ should handle queries without semicolons
      ✓ should position CodeLenses correctly

FAIL src/test/suite/tabManagement.test.ts
  Tab Management Tests
    Tab Creation and Management
      ✓ createTabWithId should create tab with specific ID (5 ms)
      ✕ getOrCreateActiveTabId should request active tab from webview (4 ms)
      ✓ closeActiveTab should send closeActiveTab message
      ✓ closeOtherTabs should send closeOtherTabs message (1 ms)
      ✓ closeAllTabs should send closeAllTabs message
    Tab Loading and Results
      ✓ showLoadingForTab should show loading for specific tab
      ✓ showResultsForTab should show results for specific tab (1 ms)
      ✓ showErrorForTab should show error for specific tab
    Webview Interaction
      ✓ should handle tab creation without webview gracefully (1 ms)
      ✓ getOrCreateActiveTabId should return valid tab ID even without webview

  ● Tab Management Tests › Tab Creation and Management › getOrCreateActiveTabId should request active tab from webview

    assert.strictEqual(received, expected)

    Expected value to strictly be equal to:
      "reuseOrCreateActiveTab"
    Received:
      "createTab"

    Difference:

    - Expected
    + Received

    - reuseOrCreateActiveTab
    + createTab

      75 |       assert.ok(postMessageStub.calledOnce);
      76 |       const message = postMessageStub.firstCall.args[0];
    > 77 |       assert.strictEqual(message.type, 'reuseOrCreateActiveTab');
         |              ^
      78 |       assert.strictEqual(message.query, query);
      79 |       assert.strictEqual(message.title, title);
      80 |       assert.ok(typeof tabId === 'string');

      at Object.<anonymous> (src/test/suite/tabManagement.test.ts:77:14)

PASS src/test/suite/persistence.test.ts
  ResultsViewProvider Persistence
    ✓ should save state when a tab is created (3 ms)
    ✓ should load state on initialization (102 ms)
    ✓ should update state when results are shown (1 ms)

PASS src/test/suite/password.test.ts
  Password Security Tests
    ✓ should register password management commands (3 ms)
    ✓ should store password securely when set
    ✓ should clear password when empty string is provided
    ✓ should clear password when clear command is called
    ✓ should retrieve password from secret storage during query execution

PASS src/test/suite/commands.test.ts
  Command Tests
    Command Registration
      ✓ should register all required commands (256 ms)
      ✓ should register password management commands (1 ms)
      ✓ should register export command
    Command Handler Behavior
      ✓ tab management commands should not throw when resultsViewProvider is undefined
      ✓ query commands should handle missing resultsViewProvider gracefully (1 ms)
    Backward Compatibility
      ✓ sql.runCursorQuery should still be available for backward compatibility (1 ms)
      ✓ sql.runCursorQuery should create new tab by default

PASS src/test/suite/mcpServer.test.ts
  MCP Server Test Suite
    ✓ BigInt serialization in JSON.stringify (7 ms)
    ✓ get_active_tab_info tool handles BigInt correctly (2 ms)
    ✓ Server startup handles EADDRINUSE gracefully (17 ms)
    ✓ Server startup retries on EADDRINUSE and succeeds (5 ms)

PASS src/test/suite/pagination.test.ts
  Pagination Tests
    ✓ should fetch multiple pages until maxRowsToDisplay is reached (513 ms)
    ✓ should stop fetching when maxRowsToDisplay is reached (504 ms)
    ✓ should handle pagination errors gracefully (503 ms)

---------------------------|---------|----------|---------|---------|--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
File                       | % Stmts | % Branch | % Funcs | % Lines | Uncovered Line #s                                                                                                                                                                                                  
---------------------------|---------|----------|---------|---------|--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
All files                  |   56.09 |    44.72 |   58.24 |   56.18 |                                                                                                                                                                                                                    
 PrestoCodeLensProvider.ts |   90.32 |       75 |     100 |   90.32 | 40-41,56                                                                                                                                                                                                           
 extension.ts              |   48.72 |    39.13 |   46.87 |   48.96 | 112-114,120-122,128-132,138-143,160-168,179-182,196-228,234-241,250-259,299-314,330-359,370-376,383,388-389,399-442,447-448,472,486-490,605-618,623-633,683-693,697,795,798,807-823,837,845,861,908-1079,1088-1093 
 mcpServer.ts              |   56.32 |    18.75 |   52.94 |   56.32 | 33-34,47-52,68-72,99-105,118-149,164-165,170-173,209-210                                                                                                                                                           
 resultsViewProvider.ts    |   61.75 |    53.21 |    67.5 |   61.63 | 50,56-58,84-90,96-98,116-117,121-130,140-141,145-154,169-191,208-219,228,235-248,254,259-278,396,412,529-530,579-615,623,627-633,651-655,676,698,704,717,732,776,782,801-822,841-865,954-999                       
---------------------------|---------|----------|---------|---------|--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
Test Suites: 1 failed, 9 passed, 10 total
Tests:       1 failed, 70 passed, 71 total
Snapshots:   0 total
Time:        4.128 s
Ran all test suites.
